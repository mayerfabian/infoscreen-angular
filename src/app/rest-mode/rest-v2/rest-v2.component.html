<div class="restv2-content">
  @if (offeneEinsaetze().length === 0) {
    <div class="restv2-history">
      <div class="history-scroll">
        <div class="history-list">
          @for (h of history(); track h.einsatzdatum_iso) {
            <div class="history-row">
              <div class="hbadge" [ngClass]="
                (h.einsatzalarmstufe || '').toUpperCase().startsWith('B') ? 'hbadge-b' :
                (h.einsatzalarmstufe || '').toUpperCase().startsWith('T') ? 'hbadge-t' :
                (h.einsatzalarmstufe || '').toUpperCase().startsWith('S') ? 'hbadge-s' : 'hbadge-x'
              ">{{ (h.einsatzalarmstufe || '??').slice(0,2).toUpperCase() }}</div>

                            <div class="history-left">
                <div class="history-grund">{{ h.einsatzgrund }}</div>
                <div class="history-ort">@if (h.einsatzort) { {{ h.einsatzort }} } @else { &mdash; }</div>
              </div>
              <div class="history-right">
                <span class="history-date">{{ h.einsatzdatum_iso | date:'EEEE, dd.MM.yyyy' }}</span>
                <span class="history-clock">{{ h.einsatzdatum_iso | date:'HH:mm:ss' }}</span>
                <span class="history-ago">{{ agoText(h.einsatzdatum_iso) }}</span>
              </div>
              </div>
          }
        </div>
      </div>
    </div>
  } @else if (offeneEinsaetze().length === 1) {
    <!-- Ein einzelner Einsatz, kein Carousel nÃ¶tig -->
    <div class="restv2-single">
      @for (e of offeneEinsaetze(); track e.einsatznummer) {
        <article class="restv2-card panel" aria-label="Offener Einsatz">
          <header class="restv2-card__header">
            <div class="restv2-card__title">
              <span class="restv2-card__einsatznr">{{ e.einsatznummer }}</span>
              <span class="restv2-card__alarmstufe">{{ e.alarmstufe }}</span>
            </div>
            <div class="restv2-card__subtitle">
              <span class="restv2-card__ort">@if (e.ort) { {{ e.ort }} } @else { &mdash; }</span>
              <span class="restv2-card__time">{{ e.einsatzdatum_iso | date:'dd.MM.yyyy, HH:mm' }}</span>
            </div>
          </header>

          <div class="restv2-card__body">
            <div class="restv2-card__grund">{{ e.grund }}</div>

            <!-- Tagebuch -->
            @if (entriesForDisplay(e).length > 0) {
              <div class="restv2-logcols">
                @for (entry of entriesForDisplay(e); track entry.id) {
                  <div class="restv2-logitem restv2-logitem--column">
                    <div class="restv2-logitem__head">
                      <span class="restv2-chip">{{ entry.meldungskategorie }}</span>
                      <span class="restv2-time">{{ entry.datetime_iso | date:'dd.MM.yyyy, HH:mm:ss' }}</span>
                    </div>
                    <div class="restv2-logitem__text">
                      @if (entry.fzg) { <span class="restv2-fzg">[{{ entry.fzg }}]</span> }
                      <span class="restv2-text">{{ entry.text }}</span>
                      @if (entry.verfasst_von.anzeige_name) {
                        <span class="restv2-author">&mdash; {{ entry.verfasst_von.anzeige_name }}</span>
                      }
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="restv2-logempty">Noch keine EintrÃ¤ge vorhanden.</div>
            }
          </div>

          <!-- Fahrzeuge / Fallback -->
          @if (!!e.fahrzeuge?.length) {
            <footer class="restv2-card__footer">
              <div class="vbtn-row" role="group" aria-label="Fahrzeuge">
                @for (f of e.fahrzeuge; track f.rufname) {
                  <button type="button" class="vbtn" [ngClass]="btnClass(f)" [attr.title]="btnTitle(f)">
                    <div class="vbtn__name">{{ nameOf(f) }}</div>
                    <div class="vbtn__meta">km: {{ kmOf(f) }} &middot; Mann: {{ mannOf(f) }}</div>
                  </button>
                }
              </div>
            </footer>
          } @else {
            <footer class="restv2-card__footer">
              <div class="no-fzg-badge" role="note">Keine Fahrzeuge disponiert</div>
            </footer>
          }
        </article>
      }
    </div>
  } @else {
    <!-- 1 pro Slide, Schrittweite 100% -->
    <div class="restv2-carousel" role="region" aria-roledescription="carousel">
      <div
        class="restv2-track"
        [style.transform]="'translateX(-' + (slideIndex() * 100) + '%)'"
        [style.transition]="noTransition() ? 'none' : 'transform 600ms ease'"
        (transitionend)="onTransitionEnd($event)"
        aria-live="polite"
      >
        @for (e of slides(); let i = $index; track i) {
          <article class="restv2-card restv2-slide panel" aria-label="Offener Einsatz">
            <header class="restv2-card__header">
              <div class="restv2-card__title">
                <span class="restv2-card__einsatznr">{{ e.einsatznummer }}</span>
                <span class="restv2-card__alarmstufe">{{ e.alarmstufe }}</span>
              </div>
              <div class="restv2-card__subtitle">
                <span class="restv2-card__ort">@if (e.ort) { {{ e.ort }} } @else { &mdash; }</span>
                <span class="restv2-card__time">{{ e.einsatzdatum_iso | date:'dd.MM.yyyy, HH:mm' }}</span>
              </div>
            </header>

            <div class="restv2-card__body">
              <div class="restv2-card__grund">{{ e.grund }}</div>

              @if (entriesForDisplay(e).length > 0) {
                <div class="restv2-logcols">
                  @for (entry of entriesForDisplay(e); track entry.id) {
                    <div class="restv2-logitem restv2-logitem--column">
                      <div class="restv2-logitem__head">
                        <span class="restv2-chip">{{ entry.meldungskategorie }}</span>
                        <span class="restv2-time">{{ entry.datetime_iso | date:'dd.MM.yyyy, HH:mm:ss' }}</span>
                      </div>
                      <div class="restv2-logitem__text">
                        @if (entry.fzg) { <span class="restv2-fzg">[{{ entry.fzg }}]</span> }
                        <span class="restv2-text">{{ entry.text }}</span>
                        @if (entry.verfasst_von.anzeige_name) {
                          <span class="restv2-author">&mdash; {{ entry.verfasst_von.anzeige_name }}</span>
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="restv2-logempty">Noch keine EintrÃ¤ge vorhanden.</div>
              }
            </div>

            @if (!!e.fahrzeuge?.length) {
              <footer class="restv2-card__footer">
                <div class="vbtn-row" role="group" aria-label="Fahrzeuge">
                  @for (f of e.fahrzeuge; track f.rufname) {
                    <button type="button" class="vbtn" [ngClass]="btnClass(f)" [attr.title]="btnTitle(f)">
                      <div class="vbtn__name">{{ nameOf(f) }}</div>
                      <div class="vbtn__meta">km: {{ kmOf(f) }} &middot; Mann: {{ mannOf(f) }}</div>
                    </button>
                  }
                </div>
              </footer>
            } @else {
              <footer class="restv2-card__footer">
                <div class="no-fzg-badge" role="note">Keine Fahrzeuge disponiert</div>
              </footer>
            }
          </article>
        }
      </div>
    </div>
  }
</div>


